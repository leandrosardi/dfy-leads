<%
search_keyword = @login.user.preference('dfy-leads.orders.search_keyword', '', params[:search_keyword])
selected_ids = @login.user.preference('dfy-leads.orders.selected_ids', '', nil)
ids = selected_ids.split(',')

all = "
    select 
        o.id, 
        o.name,
        o.create_time,
        o.status,
        u.id as id_user,
        u.name as user_name,
        e.filename as filename,
        coalesce(o.stat_sns_search_leads, 0) as stat_sns_search_leads,
        coalesce(o.stat_sns_scraped_pages, 0) as stat_sns_scraped_pages,
        coalesce(o.stat_sns_scraped_leads, 0) as stat_sns_scraped_leads,
        coalesce(o.stat_sns_leads_appended, 0) as stat_sns_leads_appended,
        coalesce(o.stat_sns_leads_verified, 0) as stat_sns_leads_verified
    from scr_order o
    left join fl_export e on e.id=o.id_export
    join \"user\" u on ( u.id_account='#{@login.user.id_account}' and u.id=o.id_user )
    where o.delete_time is null
"

all += " 
    and (
        lower(o.name) like '%#{search_keyword.downcase}%'
    )
" unless search_keyword.empty?

all += "
    order by o.create_time desc
"

# TODO: use re-utilizable function here.
page_size = 25
total_rows = DB[all].count
if total_rows>0
  total_pages = (total_rows.to_f/page_size.to_f).ceil
  # if there is a GET parameters `number` on the URL, update the user preference regarding the page number on this screen
  # then, get user preferences regarding the page number on this screen
  page_number = @login.user.preference("dfy-leads.orders.pagination.page", 1, params[:number].nil? ? nil : params[:number].to_i)
  # pagination correction to prevent glitches
  page_number = 1 if page_number < 1
  page_number = total_pages if page_number > total_pages
  # calculate info for showing at the bottom of the table
  from_row = (page_number.to_i-1) * page_size.to_i + 1
  to_row = [page_number*page_size, total_rows].min
else
  total_pages = 1
  page_number = 1
  from_row = 0
  to_row = 0
end

q = "
"+all+"
  LIMIT #{page_size.to_s}
  OFFSET #{((page_number.to_i - 1) * page_size.to_i).to_s}
"
%>

<!-- NavBar -->
<div class="mynavbar mysticky">
	<section class="row-fluid">	
		<div class="span6">
		    <%=nav2("DFY Leads", "/dfy-leads", "Orders")%>
		</div>
		<div class="span6" style='text-align:right;'>
            <form action="/dfy-leads/orders" method="get">
                <input type='hidden' name='ids' id='ids' value='' />
                <div class="pull-right">
                    <div class="span8">
                        <input type='text' class='input-block-level select-all-on-focus' id='search_keyword' name='search_keyword' value='<%=search_keyword.encode_html%>' />
                    </div>
                    <button class="btn btn-blue btn-medium btn-submit" style="margin-left: 2px;" type="submit" onclick="">
                        <i class='icon-search'></i> Search
                    </button>
                </div>    

                <a class='btn btn-blue' href='/dfy-leads/orders/new' title='New Order'><i class='icon-plus'></i> New</a>
                <button type="button" class="btn btn-blue" data-toggle="modal" id='play-order' name='play-order' data-rows-group-id='orders' title='Resume Order'><i class='icon-play'></i> Play</button>
                <button type="button" class="btn btn-blue" data-toggle="modal" id='pause-order' name='pause-order' data-rows-group-id='orders' title='Pause Order'><i class='icon-pause'></i> Pause</button>
            </form>
        </div>
	</section>
</div>

<!-- Single Panel -->
<section class="row-fluid">
	<div class="span12 box">
        <p><b>Records:</b> <%=from_row.to_label%> to <%=to_row.to_label%> <b>of</b> <%=total_rows.to_label%></p>
        <table class="table table-condensed" style="table-layout: fixed; width: 100%;">
            <thead>
                <th style="width:24px;"><input type='checkbox' class='select-all-rows' data-rows-group-id='orders' data-input-id='ids' /></th>
                <th style="width:auto;">Name</th>
                <th style="width:150px;">Assignee</th>
                <th style="width:24px;">Status</th> <!-- idle, working, failed -->
                <th style="width:75px;text-align:right;">LinkedIn<br/>Results</th>
                <th style="width:75px;text-align:right;">Scraped<br/>Results</th>
                <th style="width:75px;text-align:right;">Appended<br/>Results</th>
                <th style="width:75px;text-align:right;">Verified<br/>Results</th>
                <th style="width:14px;"><!-- download --></th>
                <th style="width:14px;"><!-- edit --></th>
                <th style="width:14px;"><!-- delete --></th>
            </thead>
            <tbody>
                <%
                i = 0
                DB[q].all do |row|
                    i += 1                    
                    a = row[:stat_sns_search_leads].nil ? 0.to_f : row[:stat_sns_scraped_leads].to_f / row[:stat_sns_search_leads].to_f
                    b = row[:stat_sns_scraped_leads].nil ? 0.to_f : row[:stat_sns_leads_appended].to_f / row[:stat_sns_scraped_leads].to_f
                    c = row[:stat_sns_leads_appended].nil ? 0.to_f : row[:stat_sns_leads_verified].to_f / row[:stat_sns_leads_appended].to_f
                %>
                <tr>
                    <th><input type='checkbox' class='select-row' data-id='<%=row[:id].to_guid%>' data-rows-group-id='orders' <%=ids.include?(row[:id].to_guid) ? 'checked' : ''%> /></th>
                    <td class="fix" title="<%=row[:name].to_s.encode_html%>"><a href='/dfy-leads/orders/<%=row[:id].to_guid%>/edit'><%=row[:name].to_s.encode_html%></a></td>
                    <td class="fix" title="<%=row[:user_name].to_s.encode_html%>"><%=row[:user_name].to_s.encode_html%></td>
                    <td class="fix" title="<%=row[:status] ? 'ON' : 'OFF'%>"><i class='icon-circle' style='color:<%=row[:status] ? 'green' : 'red'%>'></i></td>

                    <td class="fix" style="text-align:right;" title="<%=row[:stat_sns_search_leads].to_label%>"><%=row[:stat_sns_search_leads].to_label%><br/></td>
                    <td class="fix" style="text-align:right;" title="<%=row[:stat_sns_scraped_leads].to_label%>"><%=row[:stat_sns_scraped_leads].to_label%><br/><span style='color:gray;'><%=a.ceil%>%</span></td>
                    <td class="fix" style="text-align:right;" title="<%=row[:stat_sns_leads_appended].to_label%>"><%=row[:stat_sns_leads_appended].to_label%><br/><span style='color:gray;'><%=b.ceil%>%</span></td>
                    <td class="fix" style="text-align:right;" title="<%=row[:stat_sns_leads_verified].to_label%>"><%=row[:stat_sns_leads_verified].to_label%><br/><span style='color:gray;'><%=c.ceil%>%</span></td>
                    
                    <td class="fix" style="text-align:right;">
                        <%
                        if row[:filename]
                        %>
                        <a href="/clients/<%=@login.user.id_account.to_guid%>/leads.exports/<%=row[:filename].to_s.encode_html%>.csv" class="btn btn-link"><i class='icon-cloud-download'></i></a>
                        <%
                        else #if row[:filename]
                        %>
                        <i>pending</i>
                        <%
                        end #if row[:filename]
                        %>
                    </td>
                    <td class="fix" style="text-align:right;"><a title='Edit' href='/dfy-leads/orders/<%=row[:id].to_guid%>/edit'><i class='icon-pencil'></i></a></td>
                    <td class="fix" style="text-align:right;"><a title='Delete' href='/dfy-leads/filter_delete_order?id=<%=row[:id].to_guid%>'><i class='icon-trash'></i></a></td>
                </tr>
                <%
                end

                if i==0
                %>
                <tr>
                    <td colspan="8" class="fix" align='center' style='text-align:center;'>
                        <br/>
                        No orders found.</br>
                        <a href='/dfy-leads/orders/new'>Place a new order here.</a>
                    </td>
                <tr>
                <%
                end
                %>
            </tbody>
        </table>
        <div class="pagination"></div>
    </div>
</section>

<script>
    $(document).ready(function() {
        drawPagination($(".pagination"), <%=page_number%>, <%=total_pages%>);
        selectRowsJs.init();
    });
</script>